<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat WebSocket</title>
</head>

<body>
    <h2>Chat en direct</h2>

    <div id="chat">
        <h3>Utilisateurs connectÃ©s :</h3>
        <ul id="users"></ul>

        <h3>Messages :</h3>
        <ul id="messages"></ul>

        <input id="message" type="text" placeholder="Ã‰crivez un message">
        <button onclick="sendMessage()">Envoyer</button>
    </div>

    <script>
        let socket;
        let username;

        async function fetchUsername() {
            try {
                const response = await fetch('https://localhost:8080/api/get-user');
                const data = await response.json();
                console.log("Utilisateur rÃ©cupÃ©rÃ© :", data);
                if (data.username) {
                    username = data.username;
                    connectWebSocket();
                } else {
                    alert("Vous devez Ãªtre connectÃ© !");
                    window.location.href = "/login";
                }
            } catch (error) {
                console.error("Erreur lors de la rÃ©cupÃ©ration de l'utilisateur :", error);
                window.location.href = "/login";
            }
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
            socket = new WebSocket(protocol + window.location.host + "/ws");

            socket.onopen = function () {
                console.log("âœ… Connexion WebSocket Ã©tablie !");
            };

            socket.onmessage = function (event) {
                const msg = JSON.parse(event.data);

                if (msg.type === "user_list") {
                    updateUserList(JSON.parse(msg.content));
                } else {
                    const li = document.createElement("li");
                    li.textContent = msg.username + ": " + msg.content;
                    document.getElementById("messages").appendChild(li);
                }
            };

            socket.onclose = function () {
                console.warn("âš ï¸ Connexion WebSocket fermÃ©e.");
            };
        }

        function sendMessage() {
            const message = document.getElementById("message").value;
            if (message && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: "message", content: message }));
                document.getElementById("message").value = "";
            }
        }

        function updateUserList(users) {
            const usersList = document.getElementById("users");
            usersList.innerHTML = "";
            users.forEach(user => {
                const li = document.createElement("li");
                li.textContent = user;
                usersList.appendChild(li);
            });
        }
        console.log("ğŸš€ - Page chargÃ©e !");
        // RÃ©cupÃ©rer l'utilisateur connectÃ© au chargement
        fetchUsername();
    </script>
</body>

</html>