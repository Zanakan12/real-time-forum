<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat WebSocket</title>
</head>

<body>
    <h2>Chat en direct</h2>

    <div id="chat">
        <h3>Utilisateurs connectés :</h3>
        <ul id="users"></ul>

        <h3>Messages :</h3>
        <ul id="messages"></ul>

        <input id="message" type="text" placeholder="Écrivez un message">
        <input id="send-msg-button" type="button" value="Envoyer"></button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            let socket;
            let username;
            const sendMessageButton = document.getElementById("send-msg-button")
            sendMessageButton.addEventListener("click", ()=>{
                sendMessage();
            });
            async function fetchUserData() {
                try {
                    const response = await fetch('https://localhost:8080/api/get-user');
                    const data = await response.json();

                    if (data.username) {
                        username = data.username;
                        connectWebSocket();
                    } else {
                        window.location.href = "/login";
                    }
                } catch (error) {
                    console.error("❌ Erreur lors de la récupération de l'utilisateur :", error);
                    window.location.href = "/login";
                }
            }

            async function fetchConnectedUsers() {
                try {
                    const response = await fetch('https://localhost:8080/api/users');
                    const users = await response.json();
                    updateUserList(users);
                } catch (error) {
                    console.error("❌ Erreur lors de la récupération des utilisateurs connectés :", error);
                }
            }

            function connectWebSocket() {
                const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
                socket = new WebSocket(protocol + window.location.host + "/ws");

                socket.onopen = function () {
                    console.log("✅ Connexion WebSocket établie !");
                    fetchConnectedUsers(); // Met à jour la liste des utilisateurs connectés
                };

                socket.onmessage = function (event) {
                    const msg = JSON.parse(event.data);

                    if (msg.type === "user_list") {
                        updateUserList(JSON.parse(msg.content));
                    } else if (msg.type === "message") {
                        appendMessage(msg.username, msg.content);
                    }
                };

                socket.onclose = function () {
                    console.warn("⚠️ Connexion WebSocket fermée.");
                };
            }

            function sendMessage() {
                const messageInput = document.getElementById("message");
                const message = messageInput.value.trim();
                appendMessage("zanakan",message)
                console.log(message)
                if (message && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: "message", content: message }));
                    messageInput.value = "";
                }
            }

            function updateUserList(users) {
                console.log("👥 Mise à jour de la liste des utilisateurs :", users);
                const usersList = document.getElementById("users");
                usersList.innerHTML = "";

                JSON.parse(users).forEach(user => {
                    const li = document.createElement("li");
                    li.textContent = user;
                    usersList.appendChild(li);
                });
            }

            function appendMessage(user, content) {
                const messagesList = document.getElementById("messages");
                const li = document.createElement("li");
                li.textContent = `${user}: ${content}`;
                messagesList.appendChild(li);
            }

            console.log("🚀 - Page chargée !");
            await fetchUserData();
        });
    </script>
</body>

</html>